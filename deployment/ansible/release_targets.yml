# TODO
# Option: run the script with strategy: free, so all the nodes will run simultaneously but they will not wait for each other 

---
- hosts: 192.168.12.50, 192.168.12.51, 192.168.12.52, 192.168.12.53, 192.168.12.54, 192.168.12.55, 192.168.12.56, 192.168.12.57, 192.168.12.58, 192.168.12.59, 192.168.12.60, 192.168.12.61, 192.168.12.62, 192.168.12.63, 192.168.12.64, 192.168.12.65, 192.168.12.66, 192.168.12.67, 192.168.12.68, 192.168.12.69, 192.168.12.70
# Nodes 81, 84 and 85 will produce noise..
  strategy: free
  remote_user: videk

# Select which application to test, duration in minutes
  #vars:
  #  application: 05_benchmark-acs
  #  duration: 10
  #  autostart: false

# Display experiment abstract in build.log 
# TODO: How to display abstract only once, not at every node?
#  tasks:
#  - name: Display abstract
#    debug:
#      msg: "Testing {{application}}, duration {{duration}} minutes"
#    when: inventory_hostname == 192.168.12.81

  tasks:
  - name: Create directory
    file:
      path: ~/deploy/logatec-experiment
      state: directory

# Recursive option will also download the sub-modules
# Update will pull the changes from Github
# Force will delete local changes
# Version you can change which branch to pull
  - name: Pull changes from github
    git:
      repo: git@github.com:logatec3/logatec-experiment.git
      dest: ~/deploy/logatec-experiment
      recursive: no
      update: yes
      force: yes
      depth: 1
      version: experiment/BLE


# Build...with -f flag so we can copy 'logatec-experiment' directory into container
  - name: Build docker file
    command: docker build -t logatec-experiment-ble -f deployment/docker/Dockerfile . 
    args:
      chdir: ~/deploy/logatec-experiment

  - name: Cleanup old docker containers (target)
    register: target
    ignore_errors: yes
    command: "{{ item }}"
    with_items:
      - docker kill target_ble_bruno
      - docker rm target_ble_bruno

  - name: Run docker image
    command: docker run --name target_ble_bruno --privileged --net=host -e TARGET=experiment_with_controller logatec-experiment-ble
