---
- hosts: 192.168.12.81
  strategy: free
  remote_user: videk

  # Select which application to test, duration in minutes and additional options (none/monitor/root/node)
  vars:
    technology: master
    application: 00_template
    duration: 20
    option: none

  tasks:
    - name: Create directory
      file:
        path: ~/deploy
        state: directory

    - name: Deploy experiment repository
      synchronize:
        src: "{{ lookup('env','PWD') }}"
        dest: ~/deploy
        delete: yes
        recursive: yes
  
    - name: Build the docker file
      command: docker build -t logatec-experiment -f deployment/docker/Dockerfile . 
      args:
        chdir: ~/deploy/logatec-experiment
  
    - name: Cleanup old docker containers
      ignore_errors: yes
      command: "{{ item }}"
      with_items:
        - docker kill target-{{ technology }}
        - docker rm target-{{ technology }}
  
    - name: Run docker container
      command: docker run --name target-{{technology}} --privileged --net=host -e APP="{{application}}" -e APP_DUR="{{duration}}" -e OPTION="{{option}}" logatec-experiment
  