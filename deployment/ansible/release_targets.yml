# TODO
# Option: run the script with strategy: free, so all the nodes will run simultaneously but they will not wait for each other 

---
- hosts: UWB_indor_1:!offline
  strategy: free
  remote_user: videk

# Select which application to test, duration in minutes and additional options (none/monitor/master/slave)
  vars:
    application: 00_demo
    duration: 10
    option: none  # defined at task: run docker image"
    master_node: "192.168.12.159"

  tasks:
  - name: Create directory
    file:
      path: ~/deploy/logatec-experiment
      state: directory

# Recursive option will also download the sub-modules
# Update will pull the changes from Github
# Force will delete local changes
# Version you can change which branch to pull
  - name: Pull changes from github
    git:
      repo: git@github.com:logatec3/logatec-experiment.git
      dest: ~/deploy/logatec-experiment
      recursive: no
      update: yes
      force: yes
      depth: 1
      version: UWB

# It is better to download sub-modules separately, otherwise you get 95MB of data instead 28MB
# Recursive option will download all sub-modules (also the ones from Contiki) which we don't need
#  - name: Update submodules
#    command: git submodule update --init
#    args:
#      chdir: ~/deploy/logatec-experiment

# Delete potential local changes (since force option in git task doesn't work for submodules)
#  - name: Delete local changes
#    shell: "{{ item }} "
#    with_items:
      #- cd ~/deploy/logatec-experiment && git clean -f -d
      #- cd ~/deploy/logatec-experiment/contiki-ng && git clean -f -d
      #- cd ~/deploy/logatec-experiment/vesna-drivers && git clean -f -d

# Build...with -f flag so we can copy 'logatec-experiment' directory into container
  - name: Build docker file
    command: docker build -t logatec-experiment-uwb -f deployment/docker/Dockerfile . 
    args:
      chdir: ~/deploy/logatec-experiment

  - name: Cleanup old docker containers (target-uwb)
    register: target
    ignore_errors: yes
    command: "{{ item }}"
    with_items:
      - docker kill target-uwb
      - docker rm target-uwb

  - name: Run docker image
    command: docker run --name target-uwb --privileged --net=host -e APP="{{application}}" -e APP_DUR="{{duration}}" -e OPTION="slave" logatec-experiment-uwb
    when: inventory_hostname != master_node

  - name: Run anchor docker image
    command: docker run --name target-uwb --privileged --net=host -e APP="{{application}}" -e APP_DUR="{{duration}}" -e OPTION="master"  logatec-experiment-uwb
    when: inventory_hostname == master_node
