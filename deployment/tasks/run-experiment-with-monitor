#!/usr/bin/env bash

# Run experiment - with mode: monitor

# ----------------------------------------------------------------------------------------------------------
# Prepare a device for the experiment
# ----------------------------------------------------------------------------------------------------------
# Obtain LGTC name - last 3 digits of node IP adresses
IPADDR=$(hostname -I)
IPADDR=${IPADDR#*"192.168.12."}
IPADDR=${IPADDR:0:3}

# Optain application location and filename
APP_LOC=$APP
APP_NAME=${APP:3}

echo "Deploying $APP application on node $IPADDR with option: monitor"

# ----------------------------------------------------------------------------------------------------------
# Start the experiment application using monitor ECMS_client.
# ----------------------------------------------------------------------------------------------------------
# Start BT advertisment
#hciconfig hci0 leadv3

echo "Resetting BLE device"
hciconfig hci0 reset
hciconfig hci0 down
hciconfig hci0 up
hciconfig hci0 rstat
hcitool -i hci0 cmd 0x03 0x0003
echo "Done"

# Start the ECMS_client with experiment application
#sed -i 's/Debugging = False/Debugging = True/' /usr/local/lib/python3.8/dist-packages/bluepy/btle.py
cd /root/logatec-experiment/monitor/
python3 experiment_LGTC.py $IPADDR $APP_LOC $APP_NAME



#cd /root/logatec-experiment/applications/01_localization
#python3 testna2.py $IPADDR




# ----------------------------------------------------------------------------------------------------------
# Move the measured data and logg files into results folder.
# ---------------------------------------------------------------------------------------------------------
mv *.log /root/logatec-experiment/results/
# Measurements will be moved by experiment application, so next line is obolete
#mv *.txt /root/logatec-experiment/results/lts/

# ----------------------------------------------------------------------------------------------------------
# Cleanup (stop BLE advertising)
# ----------------------------------------------------------------------------------------------------------
#hciconfig hci0 noleadv