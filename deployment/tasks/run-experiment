#!/usr/bin/env bash

# Get only last 3 digits of IP address
IPADDR=$(hostname -I)
IPADDR=${IPADDR#*"192.168.12."}
IPADDR=${IPADDR:0:3}

# Remove first 3 characters from APP_DIR string to get the app name
APP_LOC="/root/logatec-experiment/applications/${APP}"
echo "Deploying ${APP:3} application on node $IPADDR"

# Locate .bin file for slave
BIN_FILE="${APP_LOC}/binary/slave.bin"

# Flash the UWB node with given application binaries
python3 snp_uwb_flash.py $BIN_FILE

# Rename logg file and move it to the results folder
mv flash_report.log flash_report_${IPADDR}.log
mv *.log /root/logatec-experiment/results/

# Get device ID
cd $APP_LOC
python3 uwb_getid.py $IPADDR
mv *.txt /root/logatec-experiment/results/

# Sleep for defined perion of experiment duration
sleep ${APP_DUR}m

# Put UWB into reset state so it doesnt interfeer with other experiments
cd /root/logatec-experiment/deployment/tasks
python3 snp_uwb_poweroff.py