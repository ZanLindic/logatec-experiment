#!/usr/bin/env bash

# Run experiment master - with no additional option

# ----------------------------------------------------------------------------------------------------------
# Prepare a device for the experiment
# ----------------------------------------------------------------------------------------------------------
# Obtain LGTC name - last 3 digits of node IP adresses
IPADDR=$(hostname -I)
IPADDR=${IPADDR#*"192.168.12."}
IPADDR=${IPADDR:0:3}

# Optain application location and filename
APP_LOC=$APP
APP_NAME=${APP:3}

echo "Deploying ${APP:3} application on node $IPADDR in master mode"

# ----------------------------------------------------------------------------------------------------------
# Flash the device with corresponding binary file.
# ----------------------------------------------------------------------------------------------------------
# Locate .bin file for slave
BIN_FILE="/root/logatec-experiment/applications/${APP_LOC}/binary/master.bin"

# Flash the UWB node with given application binaries
python3 snp_uwb_flash.py $BIN_FILE

# Rename logg file and move it to the results folder
mv flash_report.log flash_report_${IPADDR}.log
mv *.log /root/logatec-experiment/results/

# ----------------------------------------------------------------------------------------------------------
# Start the serial monitor script that collects results and exits after a defined time $APP_DUR
# TODO: za ime lahko uporabi≈° APP_NAME
# ----------------------------------------------------------------------------------------------------------
cd "/root/logatec-experiment/applications/${APP_LOC}"
python3 uwb_monitor.py $IPADDR $APP_DUR

# ----------------------------------------------------------------------------------------------------------
# Move the measured data and logg files into results folder.
# ---------------------------------------------------------------------------------------------------------
mv *.txt /root/logatec-experiment/results/
mv *.log /root/logatec-experiment/results/

# ----------------------------------------------------------------------------------------------------------
# Cleanup - put UWB to reset state so it doesn't interfeer with other networks
# ----------------------------------------------------------------------------------------------------------
cd /root/logatec-experiment/deployment/tasks
python3 snp_uwb_poweroff.py
