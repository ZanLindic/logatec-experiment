#!/usr/bin/env bash

# Run experiment - with mode: node

# ----------------------------------------------------------------------------------------------------------
# Prepare a device for the experiment
# ----------------------------------------------------------------------------------------------------------
# Obtain LGTC name - last 3 digits of node IP adresses
IPADDR=$(hostname -I)
IPADDR=${IPADDR#*"192.168.12."}
IPADDR=${IPADDR:0:3}

# Optain application location and filename
APP_LOC=$APP
APP_NAME=${APP:3}

echo "Deploying $APP application on node $IPADDR with option: node"

# ----------------------------------------------------------------------------------------------------------
# Start the experiment application (storing the results into file with IPADDR in its name)
# ----------------------------------------------------------------------------------------------------------
# Start BT advertisment
hciconfig hci0 leadv3

# Start the application
cd /root/logatec-experiment/applications/$APP_LOC
python3 $APP_NAME.py $IPADDR
# TODOB: fix the app so it can be run manually (if __name__ == "__main__":)

# ----------------------------------------------------------------------------------------------------------
# Move the measured data (and logg files) into results folder.
# ----------------------------------------------------------------------------------------------------------
mv *.txt /root/logatec-experiment/results/
mv *.log /root/logatec-experiment/results/

# ----------------------------------------------------------------------------------------------------------
# Cleanup (stop BLE advertising)
# ----------------------------------------------------------------------------------------------------------
hciconfig hci0 noleadv
