
## Config for Controller on one path
## Flask servs templates and statics, client connects here for WebSockets
        location /controller/ {
                include proxy_params;
                proxy_pass http://localhost:8001/;
                proxy_set_header Host $host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_buffering off;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
        }




## Old config (Everything separated)

upstream wsgi_server{
        server localhost:8001 fail_timeout=0;
}


server {

        listen 80;
        server_name localhost;

        # https://flask.palletsprojects.com/en/1.1.x/deploying/wsgi-standalone/?highlight=gunicorn
        # https://www.patricksoftwareblog.com/how-to-configure-nginx-for-a-flask-web-application/
        # https://www.fullstackpython.com/wsgi-servers.html
        # https://docs.gunicorn.org/en/stable/deploy.html
        location /controller/ {
                include proxy_params;
                proxy_pass http://wsgi_server/controller/;

                # Headers from Gunicorn manual: https://gunicorn.org/index.html#deployment
                proxy_set_header Host $host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-Real-IP $remote_addr;
        }

        # Neither Gunicorn nor Flask server should not serve static files...Nginx should do it
        # https://stackoverflow.com/questions/12800862/how-to-make-django-serve-static-files-with-gunicorn
        # https://sodocumentation.net/flask/topic/3678/static-files 

        # Nontheless Flask can do it anyway
        # https://stackoverflow.com/questions/20646822/how-to-serve-static-files-in-flask
        location /controller/static {
                alias /home/grega/Workspace/magistrska/07_Nginx/monitoring/static;
        }

        # Controller web socket config
        # SocketIO client (browser) will establish WS connection on servers URL with added "/socket.io"
        # If another app in SMS portal will use WS, use "namespaces" to make a multiplex out od a single WS  
        # https://flask-socketio.readthedocs.io/en/latest/
        # https://www.fullstackpython.com/websockets.html
        location /socket.io {
                include proxy_params;
                proxy_pass http://wsgi_server/socket.io;
                proxy_buffering off;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
        }
}